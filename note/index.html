<html>
  <head>
    <title>Note</title>
    <style>
      html {
        height: 100%;
      }
      body {
        background: rgb(237, 237, 192);
        padding: 0;
        margin: 0;
        font-family: monospace;
        font-size: 20px;
        height: 100%;
      }
      button {
        background: rgb(182, 194, 242);
        width: 100px;
        height: 30px;
        float: left;
        margin-right: 10px;
        font-size: 18px;
        border-radius: 10px;
        border: none;
      }
      .top,
      .bottom {
        width: 840px;
        max-width: 100%;
        margin: auto;
        display: block;
      }
      .top {
        height: 100px;
        padding-top: 40px;
        display: fixed;
      }
      input,
      input:focus,
      .bottom,
      .bottom:active,
      .bottom:focus {
        min-height: calc(100% - 200px);
        display: block;
        border: 1px solid rgb(126, 139, 160);
      }
      .help {
        color: rgb(126, 139, 160);
        font-size: large;
        display: block;
      }
      .version {
        display: none;
      }
    </style>
  </head>
  <body onload="loadFileByUrl();">
    <div class="top">
      <button onclick="setContent(''); loadFile()">new</button>
      <button onclick="saveToLocalStorage()">save</button>
      <button onclick="deleteCurrentFile()">delete</button>
      <button onclick="clearLocalStorage()">remove all</button>
      <br /><br />
      <span class="help" id="help"></span>
      <br />
    </div>
    <div
      id="content"
      class="bottom"
      placeholder="content"
      contenteditable
    ></div>
    <span class="version">0.1.0</span>
    <script>
      const action = {
        get() {
          return localStorage["action"];
        },
        new() {
          localStorage.setItem("action", "new");
        },
        save() {
          localStorage.setItem("action", "save");
        },
        delete() {
          localStorage.setItem("action", "delete");
        },
        removeAll() {
          localStorage.setItem("action", "removeAll");
        },
        loadFile() {
          localStorage.setItem("action", "loadFile");
        },
        loadFileByUrl() {
          localStorage.setItem("action", "loadFileByUrl");
        },
      };
      function setHelpMessage(message) {
        localStorage.setItem("msg", message);
      }

      function getHelpMessage() {
        return localStorage["msg"];
      }

      function getCurrentLocation() {
        return window.location.href.toString().split("?");
      }

      function getContent() {
        return document.getElementById("content").innerHTML;
      }

      function setContent(text) {
        document.getElementById("content").innerHTML = text;
      }

      function updateHelp(text) {
        let help = document.getElementById("help");
        help.innerHTML = text;
        setHelpMessage(text);
      }

      function updateUrl(title) {
        let locArray = getCurrentLocation();
        let base = locArray[0];
        let newUrl;

        if (title) {
          newUrl = [base, title].join("?");
        } else {
          newUrl = base;
        }

        window.location.href = newUrl;
        loadFile(title);
      }

      function loadFile(title) {
        let previousAction = action.get();
        action.loadFile();

        let message;
        if (previousAction === "delete") {
          message = getHelpMessage();
        } else if (!title || title === undefined) {
          message = "new file loaded. enter text below";
        } else if (localStorage[title]) {
          setContent(localStorage[title]);
          message = `'${title}' loaded successfully`;
        } else {
          message = `<span style="color: rgb(144, 42, 42);">
              '${title}' not found in local storage
            </span>`;
        }
        setHelpMessage(message);
        updateHelp(getHelpMessage());
      }

      function loadFileByUrl() {
        action.loadFileByUrl();

        let title = getCurrentLocation()[1];
        let message;
        if (!title || title === undefined) {
          message = "new file loaded. enter text below";
        } else if (localStorage[title]) {
          message = `'${title}' loaded successfully`;
          loadFile(title);
        } else {
          message = `<span style="color: rgb(144, 42, 42);">
              '${title}' not found in local storage
            </span>`;
        }

        setHelpMessage(message);
        updateHelp(getHelpMessage());
      }

      function saveToLocalStorage() {
        action.save();

        let title = new Date().getTime();
        let content = document.getElementById("content").innerText.toString();
        let message;

        if (!content) {
          message = `<span style="color: rgb(144, 42, 42);">
              enter text below before saving.
            </span>`;
          updateUrl("");
        } else {
          localStorage.setItem(title, content);
          message = `saved: ${newUrl}. reloading file...`;

          const execLoadFile = () => updateUrl(title);
          setTimeout(execLoadFile, 1500);
        }

        setHelpMessage(message);
        updateHelp(getHelpMessage());
      }

      function deleteCurrentFile() {
        action.delete();

        localStorage.removeItem(getCurrentLocation()[1]);

        let message = `removed: ${getCurrentLocation()[1]}`;
        setHelpMessage(message);
        updateHelp(getHelpMessage());

        const execLoadFile = () => updateUrl("");
        setTimeout(execLoadFile, 1500);
      }

      function clearLocalStorage() {
        action.removeAll();

        Object.keys(localStorage).forEach((item) =>
          localStorage.removeItem(item)
        );

        setContent("");

        let msg = "local storage cleared<br />";
        setHelpMessage(msg);
        updateHelp(msg);

        setTimeout(() => updateUrl(""), 2500);
      }
    </script>
  </body>
</html>
